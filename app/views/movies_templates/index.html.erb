<% if user_signed_in? %>
  <h2>Hey, <%= current_user.name %>! What are we watching today?</h2>
<% else %>
  <h2>Hey, movie fan! What are we watching today?</h2>
<% end %>

<form action="/" method="get">
  <div class="filters-row">
    <div>
      <label for="query_field">üîé Search by title</label>
      <input
        id="query_field"
        type="text"
        name="query"
        placeholder="E.g. Parasite, Gladiator..."
        value="<%= params[:query] %>"
      >
      </div>

      <div>
        <label for="genre_field">üé≠ Genre</label>
        <select id="genre_field" name="genre_id">
          <option value="">Any genre</option>
          <option value="28"   <%= "selected" if params[:genre_id] == "28" %>>Action</option>
        <option value="35"   <%= "selected" if params[:genre_id] == "35" %>>Comedy</option>
        <option value="18"   <%= "selected" if params[:genre_id] == "18" %>>Drama</option>
        <option value="27"   <%= "selected" if params[:genre_id] == "27" %>>Horror</option>
        <option value="10749"<%= "selected" if params[:genre_id] == "10749" %>>Romance</option>
        <option value="878"  <%= "selected" if params[:genre_id] == "878" %>>Sci-Fi</option>
        <option value="16"   <%= "selected" if params[:genre_id] == "16" %>>Animation</option>
        <option value="99"   <%= "selected" if params[:genre_id] == "99" %>>Documentary</option>
      </select>
    </div>

    <div>
      <label for="min_rating_field">‚≠ê Minimum rating (0‚Äì10)</label>
      <input
        id="min_rating_field"
        type="number"
        name="min_rating"
        value="<%= params[:min_rating] %>"
        min="0"
        max="10"
        step="0.5"
      >
          </div>

          <div>
            <label for="max_runtime_field">‚è± Maximum runtime (minutes)</label>
            <input
        id="max_runtime_field"
        type="number"
        name="max_runtime"
        value="<%= params[:max_runtime] %>"
        min="30"
      >
            </div>

            <div>
                <label for="provider_field">üì∫ Where to watch</label>
                <select id="provider_field" name="provider">
                <option value="">Any service</option>
                <option value="disney"  <%= "selected" if params[:provider] == "disney" %>>Disney+</option>
                <option value="hbo_max"    <%= "selected" if params[:provider] == "hbo_max" %>>HBO Max</option>
                <option value="hulu"    <%= "selected" if params[:provider] == "hulu" %>>Hulu</option>
                <option value="netflix" <%= "selected" if params[:provider] == "netflix" %>>Netflix</option>
                <option value="prime"   <%= "selected" if params[:provider] == "prime" %>>Prime Video</option>
      </select>
    </div>

     <div class="clear-filters-cell">
      <a href="/">Clear filters</a>
    </div>
    </div>
 
  <div style="text-align: center; margin-top: 1rem;">
    <button>üé¨ Find movies</button>
    </div>
</form>

<% if params[:query].present? && (params[:provider].present? || params[:max_runtime].present?) %>
  <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -0.5rem; color: red">
                  ‚ÑπÔ∏è Note: When searching by title, "Max runtime" and ‚ÄúWhere to watch‚Äù filters don't apply due to API limitations.
                </p>
              <% end %>

              <% if @movies.present? %>
                <section style="margin-top: 2rem;">
                  <h2>Results</h2>

                  <% if @suggestion_message.present? %>
                    <p><%= @suggestion_message %></p>
                  <% else %>

                    <p>Found <%=  number_with_delimiter(@total_results) %> movie<%= "s" if @total_results  != 1 %> for you!</p>

                  <% end %>

                  <table role="grid" class="results-table">
                    <thead>
                      <tr>
                        <th>Movie</th>
                        <th> ‚≠ê Rating </th>
                        <th>Release date</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @movies.each do |movie| %>
                        <tr>
                          <td>
                            <a href="/movies/<%= movie["id"] %>">
                              <strong><%= movie["title"] %></strong>
                            </a>
                          </td>
                          <td><%= (movie["vote_average"] || 0).round(1) %></td>
                          <td>  <% raw_date = movie["release_date"] %>
                            <% if raw_date.present? %>
                              <%= Date.parse(raw_date).strftime("%b %-d, %Y") %>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>

                  <!-- Pagination -->
                  <div class="pagination" style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">

                    <!-- Previous Page button -->
                    <% if @page.to_i > 1 %>
                      <%= link_to "‚Üê Previous", movies_path(request.query_parameters.merge(page: @page.to_i - 1)), class: "pagination-button" %>
                    <% end %>

                    <!-- Page indicator -->
                    <span>
                      Page <%= @page %> of <%= @total_pages %>
                    </span>

                    <!-- Next Page button -->
                    <% if @page.to_i < @total_pages.to_i %>
                      <%= link_to "Next ‚Üí", movies_path(request.query_parameters.merge(page: @page.to_i + 1)), class: "pagination-button" %>
                    <% end %>

                  </div>

                </section>
              <% end %>
